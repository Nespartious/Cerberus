# ============================================================================
# Cerberus HAProxy Development Configuration
# ============================================================================
# Simplified config for local development without Tor PROXY protocol.
# 
# Differences from production:
# - No accept-proxy (no Tor circuit IDs)
# - Uses source IP for tracking (simulates circuit behavior)
# - More relaxed timeouts for debugging
# ============================================================================

global
    log stdout format raw local0
    maxconn 4096
    nbthread 2
    
    # Runtime API socket (for Fortify integration)
    stats socket /var/run/haproxy/haproxy.sock mode 660 level admin expose-fd listeners

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    
    # Relaxed timeouts for development
    timeout connect 10s
    timeout client  30s
    timeout server  30s
    timeout http-request 10s

# --- Stick Table: Circuit Tracking (using source IP in dev) ---
backend be_stick_tables
    stick-table type ip size 100k expire 10m store conn_cur,conn_rate(10s),http_req_rate(10s),gpc0

# --- Frontend: Main Entry (Port 10000) ---
frontend ft_main
    bind *:10000
    
    # Track by source IP (simulates circuit tracking)
    http-request track-sc0 src table be_stick_tables
    
    # Add tracking header for debugging
    http-request set-header X-Circuit-ID %[src]
    
    # Security Checks
    
    # 1. Ban Check (gpc0 == 2)
    http-request deny deny_status 403 if { sc0_get_gpc0(be_stick_tables) eq 2 }
    
    # 2. Rate Limiting
    http-request deny deny_status 429 if { sc0_conn_cur(be_stick_tables) gt 20 }
    http-request deny deny_status 429 if { sc0_http_req_rate(be_stick_tables) gt 50 }
    
    # 3. Routing
    # VIPs bypass limits (gpc0 == 1)
    use_backend be_fortify_vip if { sc0_get_gpc0(be_stick_tables) eq 1 }
    
    default_backend be_fortify

# --- Backends ---
backend be_fortify
    # In dev, Fortify runs on host machine
    # host.docker.internal resolves to host on Docker Desktop
    # On Linux, use 172.17.0.1 or network_mode: host
    server fortify host.docker.internal:8888 check

backend be_fortify_vip
    server fortify host.docker.internal:8888 check
    http-request set-header X-VIP "1"

backend be_backend
    server backend backend:80 check

# --- Stats Dashboard ---
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 5s
    stats admin if TRUE
    stats show-legends
