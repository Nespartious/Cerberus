# Cerberus HAProxy Configuration
# L4 Defense: Connection Governor
#
# Implements circuit tracking, rate limiting, and connection slot management.
# 
# Location: /etc/haproxy/haproxy.cfg

global
    log /dev/log local0
    log /dev/log local1 notice
    user haproxy
    group haproxy
    daemon
    
    # Performance Limits
    maxconn 100000
    nbthread 4
    
    # Runtime API (for Fortify integration)
    stats socket /var/run/haproxy.sock mode 660 level admin

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    
    # Aggressive Timeouts (Slowloris Defense)
    timeout connect 5s
    timeout client  10s
    timeout server  10s
    timeout http-request 3s  # Kill clients sending headers too slowly

# --- Stick Table Definition ---
# Tracks Tor Circuit IDs.
# gpc0: 0=Normal, 1=VIP, 2=Banned
backend be_stick_tables
    stick-table type string len 64 size 1m expire 30m store conn_cur,conn_rate(10s),http_req_rate(10s),gpc0

# --- Lane A: Public (Port 8080) ---
# Standard Tor traffic entry point
frontend ft_tor_public
    bind 127.0.0.1:8080 accept-proxy
    
    # 1. Extract Circuit ID (from PROXY v2 header or custom header)
    # Note: Assumes Tor passes ID via PROXY protocol
    http-request set-var(req.circuit_id) fc_pp_unique_id
    
    # 2. Track in Stick Table
    http-request track-sc0 var(req.circuit_id) table be_stick_tables
    
    # 3. Security Checks
    # Ban Check
    http-request deny deny_status 403 if { sc0_get_gpc0(be_stick_tables) eq 2 }
    
    # Rate Limiting (Strict)
    # Max 10 concurrent connections, Max 20 requests per 10s
    http-request deny deny_status 429 if { sc0_conn_cur(be_stick_tables) gt 10 }
    http-request deny deny_status 429 if { sc0_http_req_rate(be_stick_tables) gt 20 }
    
    # 4. Routing
    # VIPs bypass queue (gpc0 == 1)
    use_backend be_nginx_vip if { sc0_get_gpc0(be_stick_tables) eq 1 }
    
    # Normal users go to standard backend
    default_backend be_nginx_public

# --- Lane B: Passport/VIP (Port 8081) ---
# Pre-verified traffic (has valid passport token)
frontend ft_tor_passport
    bind 127.0.0.1:8081 accept-proxy
    
    # 1. Validation
    # Must have ?passport_token=... or X-Passport-Token header
    acl has_token url_param(passport_token) -m found
    acl has_header hdr(X-Passport-Token) -m found
    http-request deny deny_status 403 unless has_token OR has_header
    
    # 2. Relaxed Limits
    # Max 50 concurrent connections
    http-request track-sc0 fc_pp_unique_id table be_stick_tables
    http-request deny deny_status 429 if { sc0_conn_cur(be_stick_tables) gt 50 }
    
    default_backend be_nginx_vip

# --- Backends ---
backend be_nginx_public
    server nginx_local 127.0.0.1:10001 maxconn 5000

backend be_nginx_vip
    server nginx_local 127.0.0.1:10001 maxconn 5000

# --- Admin Interface ---
# Only accessible via localhost for security
frontend ft_admin
    bind 127.0.0.1:9999
    
    stats enable
    stats uri /stats
    stats refresh 10s
