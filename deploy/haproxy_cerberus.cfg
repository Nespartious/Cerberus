global
    log /dev/log local0
    log /dev/log local1 notice
    user haproxy
    group haproxy
    daemon
    maxconn 100000
    nbthread 4
    stats socket /var/run/haproxy.sock mode 660 level admin expose-fd listeners

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  10s
    timeout server  10s
    timeout http-request 3s

backend be_stick_tables
    stick-table type string len 64 size 1m expire 30m store conn_cur,conn_rate(10s),http_req_rate(10s),gpc0

frontend ft_tor_public
    bind 127.0.0.1:10000 accept-proxy
    http-request set-var(req.circuit_id) fc_pp_unique_id
    http-request track-sc0 var(req.circuit_id) table be_stick_tables
    http-request deny deny_status 403 if { sc0_get_gpc0(be_stick_tables) eq 2 }
    http-request deny deny_status 429 if { sc0_conn_cur(be_stick_tables) gt 10 }
    http-request deny deny_status 429 if { sc0_http_req_rate(be_stick_tables) gt 20 }
    use_backend be_nginx_vip if { sc0_get_gpc0(be_stick_tables) eq 1 }
    default_backend be_nginx_public

backend be_nginx_public
    server nginx_local 127.0.0.1:10001 maxconn 5000
    http-request set-header X-Circuit-ID %[var(req.circuit_id)]

backend be_nginx_vip
    server nginx_local 127.0.0.1:10001 maxconn 10000
    http-request set-header X-Circuit-ID %[var(req.circuit_id)]
    http-request set-header X-VIP "1"

listen stats
    bind 127.0.0.1:8404
    mode http
    stats enable
    stats uri /
    stats refresh 5s
    stats admin if TRUE
